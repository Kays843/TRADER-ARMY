<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>TraderArmy Charts Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;padding:0;height:100%;background:#0e0e0e;color:#fff;font-family:Arial}
header{background:#111;padding:10px;display:flex;gap:10px;border-bottom:1px solid #222}
select,button,input{background:#1c1c1c;color:#fff;border:1px solid #333;padding:6px;border-radius:4px}
button{cursor:pointer}
#charts{display:grid;height:calc(100vh - 140px)}
.chart-box{border:1px solid #222;display:flex;flex-direction:column}
.chart-toolbar{padding:5px;display:flex;gap:5px;align-items:center;background:#111;border-bottom:1px solid #222}
.chart{flex:1}
.star{cursor:pointer;font-size:16px}
.star.active{color:#f5c542}
footer{background:#111;color:#aaa;font-size:12px;padding:8px;text-align:center;border-top:1px solid #222}

/* alarm */
#alarmBtn{position:fixed;right:15px;bottom:15px;background:#2962ff;border:none;padding:10px 15px;border-radius:6px;font-weight:bold}
#alarmBox{position:fixed;right:15px;bottom:60px;background:#111;border:1px solid #333;padding:10px;width:280px;display:none;border-radius:6px}
.alItem{font-size:11px;border-bottom:1px solid #222;padding:4px;display:flex;justify-content:space-between}
</style>
</head>

<body>

<header>
<strong>TraderArmy</strong>
<button onclick="setLayout(1)">1 Grafik</button>
<button onclick="setLayout(2)">2 Grafik</button>
<button onclick="setLayout(4)">4 Grafik</button>
</header>

<div id="charts"></div>

<!-- ALARM -->
<div id="alarmBox">
<strong>Alarm</strong><br><br>
<input id="alSymbol" placeholder="FXCM:NAS100"><br><br>
<input id="alPrice" type="number" placeholder="Hedef fiyat"><br><br>
<select id="alDir">
  <option value="up">‚¨Ü √úzerine √ßƒ±kƒ±nca</option>
  <option value="down">‚¨á Altƒ±na d√º≈ü√ºnce</option>
</select><br><br>
<button onclick="addAlarm()">Alarm Ekle</button>
<div id="alarmList"></div>
</div>
<button id="alarmBtn" onclick="toggleAlarm()">üîî ALARM</button>

<footer>‚ö†Ô∏è Yatƒ±rƒ±m tavsiyesi deƒüildir.</footer>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
// ================= FAVORƒ∞LER =================
let favorites = JSON.parse(localStorage.getItem("favorites")||"[]");
function toggleFav(sym){
 favorites = favorites.includes(sym)
   ? favorites.filter(x=>x!==sym)
   : [...favorites, sym];
 localStorage.setItem("favorites",JSON.stringify(favorites));
 render();
}

// ================= GRAFƒ∞K =================
let layout=localStorage.getItem("layout")||1;
const baseSymbols=[
 "FXCM:NAS100","FXCM:SPX500","FXCM:GER40","FXCM:US30",
 "FXCM:EURUSD","FXCM:GBPUSD","FXCM:USDJPY",
 "BINANCE:BTCUSDT","BINANCE:ETHUSDT"
];
const intervals=["1","5","15","60","240","D"];
let tvWidgets=[];

function allSymbols(){
 return [...favorites,...baseSymbols.filter(x=>!favorites.includes(x))];
}

function chartControls(i){
 const syms=allSymbols();
 const s=localStorage.getItem("symbol"+i)||syms[0];
 const t=localStorage.getItem("interval"+i)||"5";
 return `<div class="chart-toolbar">
 <span class="star ${favorites.includes(s)?"active":""}" onclick="toggleFav('${s}')">‚òÖ</span>
 <select onchange="changeSymbol(${i},this.value)">
 ${syms.map(x=>`<option ${x==s?"selected":""}>${x}</option>`).join("")}
 </select>
 <select onchange="changeInterval(${i},this.value)">
 ${intervals.map(x=>`<option ${x==t?"selected":""}>${x}</option>`).join("")}
 </select></div>`;
}

function render(){
 tvWidgets=[];
 const c=document.getElementById("charts");c.innerHTML="";
 if(layout==1)c.style.gridTemplateColumns="1fr";
 if(layout==2)c.style.gridTemplateColumns="1fr 1fr";
 if(layout==4)c.style.gridTemplateColumns="1fr 1fr";
 for(let i=0;i<layout;i++){
  const b=document.createElement("div");
  b.className="chart-box";
  b.innerHTML=chartControls(i)+`<div id="chart${i}" class="chart"></div>`;
  c.appendChild(b);
  const widget = new TradingView.widget({
   container_id:"chart"+i,
   autosize:true,
   symbol:localStorage.getItem("symbol"+i)||allSymbols()[0],
   interval:localStorage.getItem("interval"+i)||"5",
   theme:"dark",locale:"tr",
   onChartReady(){
     redrawAlarmLines();
   }
  });
  tvWidgets.push(widget);
 }
}
function setLayout(n){layout=n;localStorage.setItem("layout",n);render()}
function changeSymbol(i,v){localStorage.setItem("symbol"+i,v);render()}
function changeInterval(i,v){localStorage.setItem("interval"+i,v);render()}
render();

// ================= ALARM =================
let alarms=JSON.parse(localStorage.getItem("alarms")||"[]");

function toggleAlarm(){
 const b=document.getElementById("alarmBox");
 b.style.display=b.style.display==="block"?"none":"block";
}

function addAlarm(){
 const s=document.getElementById("alSymbol").value.toUpperCase();
 const p=Number(document.getElementById("alPrice").value);
 const d=document.getElementById("alDir").value;
 if(!s||!p) return;
 alarms.push({s,p,d});
 localStorage.setItem("alarms",JSON.stringify(alarms));
 drawAlarms();
 redrawAlarmLines();
 Notification.requestPermission();
}

function drawAlarms(){
 const l=document.getElementById("alarmList");
 l.innerHTML=alarms.map((a,i)=>`
 <div class="alItem">${a.s} ${a.d=="up"?"‚¨Ü":"‚¨á"} ${a.p}
 <span style="color:red;cursor:pointer" onclick="delAlarm(${i})">X</span>
 </div>`).join("");
}
function delAlarm(i){
 alarms.splice(i,1);
 localStorage.setItem("alarms",JSON.stringify(alarms));
 drawAlarms();
 redrawAlarmLines();
}
drawAlarms();

// ===== ALARM √áƒ∞ZGƒ∞LERƒ∞ =====
function redrawAlarmLines(){
 tvWidgets.forEach(w=>{
  if(!w.chart) return;
  w.chart().removeAllShapes();
  alarms.forEach(a=>{
   w.chart().createShape(
     {price:a.p},
     {
      shape:"horizontal_line",
      text:`ALARM ${a.p}`,
      color:a.d=="up"?"#00ff88":"#ff4444",
      linewidth:2
     }
   );
  });
 });
}

// ===== Fƒ∞YAT KONTROL =====
async function getPrice(sym){
 if(sym.startsWith("BINANCE:")){
  const p=sym.replace("BINANCE:","");
  const r=await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${p}`);
  return Number((await r.json()).price);
 }
 const r=await fetch(`https://symbol-search.tradingview.com/symbol_search/?text=${sym}`);
 const j=await r.json();
 return j[0]?.price;
}

async function checkAlarms(){
 for(let i=alarms.length-1;i>=0;i--){
  const a=alarms[i];
  const price=await getPrice(a.s);
  if(!price) continue;
  if((a.d=="up" && price>=a.p) || (a.d=="down" && price<=a.p)){
   new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg").play();
   if(Notification.permission==="granted"){
    new Notification("Alarm",{body:`${a.s} ‚Üí ${price}`});
   }
   alarms.splice(i,1);
   localStorage.setItem("alarms",JSON.stringify(alarms));
   drawAlarms();
   redrawAlarmLines();
  }
 }
}
setInterval(checkAlarms,5000);
</script>

</body>
</html>
