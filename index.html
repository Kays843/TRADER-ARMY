<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRADE ARMY | V.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { background: #0c0d10; margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; color: #d1d4dc; font-family: 'Inter', sans-serif; }
        #chart-grid { display: grid; height: 100%; width: 100%; gap: 1px; background: #1e222d; }
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .active-layout { background: #2962ff !important; color: white !important; }
        .side-panel { width: 280px; background: #131722; border-left: 1px solid #1e222d; transition: 0.3s; }
        .side-panel.closed { width: 0; overflow: hidden; border-left: none; }
        .alarm-flash { animation: flash 0.6s infinite; }
        @keyframes flash { 0% { background: #0c0d10; } 50% { background: #1e3a8a; } 100% { background: #0c0d10; } }
        .log-item { font-size: 10px; padding: 4px; border-bottom: 1px solid #2a2e39; color: #6b7280; }
    </style>
</head>
<body class="flex flex-col" id="mainBody">

    <header class="h-16 border-b border-[#1e222d] bg-[#131722] flex items-center justify-between px-4 shrink-0 z-50">
        <div class="flex items-center space-x-4">
            <div class="flex flex-col">
                <span class="text-white font-black italic text-lg uppercase tracking-tighter">TRADE ARMY</span>
                <span class="text-blue-500 text-[10px] font-bold">FOREX & CRYPTO ACTIVE</span>
            </div>
            <div class="flex space-x-1 bg-black/20 p-1 rounded border border-gray-800 ml-4">
                <button onclick="changeLayout(1, this)" id="btn-1" class="bg-[#1e222d] px-3 py-1 rounded text-xs active-layout">1</button>
                <button onclick="changeLayout(2, this)" id="btn-2" class="bg-[#1e222d] px-3 py-1 rounded text-xs">2</button>
                <button onclick="changeLayout(4, this)" id="btn-4" class="bg-[#1e222d] px-3 py-1 rounded text-xs">4</button>
            </div>
        </div>

        <div class="flex items-center space-x-2 bg-black/40 p-2 rounded border border-gray-800" onclick="initAudio()">
            <input type="text" id="alarmSym" placeholder="BTC / XAUUSD / NAS100" class="bg-transparent text-xs w-40 outline-none text-blue-400 font-bold uppercase">
            <input type="number" id="alarmPrice" placeholder="Fiyat" class="bg-transparent text-xs w-24 outline-none text-white font-bold">
            <button onclick="saveAlarm()" class="bg-blue-600 px-3 py-1.5 rounded text-[10px] font-bold text-white uppercase active:scale-95">Alarm Kur</button>
        </div>

        <button onclick="toggleSidePanel()" class="bg-[#1e222d] px-3 py-1.5 rounded text-xs font-bold uppercase">Liste</button>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <main class="flex-1 bg-black">
            <div id="chart-grid" class="grid-1 h-full w-full">
                <div id="tv_1" class="w-full h-full"></div>
                <div id="tv_2" class="w-full h-full hidden"></div>
                <div id="tv_3" class="w-full h-full hidden"></div>
                <div id="tv_4" class="w-full h-full hidden"></div>
            </div>
        </main>

        <aside id="sidePanel" class="side-panel p-3 flex flex-col">
            <div class="text-[10px] font-bold text-gray-500 mb-2 tracking-widest uppercase border-b border-gray-800 pb-2">Kurulu Alarmlar</div>
            <div id="alarmList" class="flex-1 space-y-2 overflow-y-auto mb-4"></div>
            <div class="text-[9px] font-bold text-gray-600 mb-2 uppercase">Canlı Fiyat Takip</div>
            <div id="priceLog" class="h-32 bg-black/20 rounded overflow-y-auto border border-gray-800 p-1"></div>
        </aside>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        let config = JSON.parse(localStorage.getItem('ta_config')) || { layout: 1, symbol: 'BINANCE:BTCUSDT' };
        let alarmlar = JSON.parse(localStorage.getItem('ta_alarms')) || [];
        let audioAllowed = false;

        function initAudio() {
            if(!audioAllowed) {
                const u = new SpeechSynthesisUtterance("Sistem Aktif");
                u.lang = 'tr-TR';
                window.speechSynthesis.speak(u);
                audioAllowed = true;
            }
        }

        function speak(text) {
            if(!audioAllowed) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'tr-TR'; u.rate = 1;
            window.speechSynthesis.speak(u);
        }

        function initChart(id, symbol) {
            new TradingView.widget({
                "autosize": true, "symbol": symbol, "interval": "60", "theme": "dark", "container_id": id,
                "locale": "tr", "toolbar_bg": "#131722", "allow_symbol_change": true, "withdateranges": true
            });
        }

        function saveAlarm() {
            initAudio();
            const sym = document.getElementById('alarmSym').value.toUpperCase();
            const prc = parseFloat(document.getElementById('alarmPrice').value);
            if(!sym || !prc) return;
            alarmlar.push({ id: Date.now(), symbol: sym, price: prc, active: true });
            localStorage.setItem('ta_alarms', JSON.stringify(alarmlar));
            renderAlarms();
            speak(sym + " alarmı eklendi");
        }

        function renderAlarms() {
            const list = document.getElementById('alarmList');
            list.innerHTML = alarmlar.map(a => `
                <div class="bg-black/30 p-2 rounded border border-gray-800 flex justify-between items-center ${!a.active ? 'opacity-20' : ''}">
                    <span class="text-[10px] font-mono"><b>${a.symbol}</b><br>${a.price}</span>
                    <button onclick="deleteAlarm(${a.id})" class="text-red-700 font-bold text-[10px]">SİL</button>
                </div>
            `).join('');
        }

        function deleteAlarm(id) {
            alarmlar = alarmlar.filter(a => a.id !== id);
            localStorage.setItem('ta_alarms', JSON.stringify(alarmlar));
            renderAlarms();
        }

        // EVRENSEL FİYAT TAKİP MOTORU (Kripto + Forex/Endeks)
        async function checkGlobalPrices() {
            const logPanel = document.getElementById('priceLog');
            
            try {
                // 1. Kripto (Binance)
                const binanceRes = await fetch('https://api.binance.com/api/v3/ticker/price');
                const binanceData = await binanceRes.json();

                // 2. Forex & Endeks (Coinbase/Yahoo/Public API Simülasyonu - Güvenli Kanallar)
                // Not: Ücretsiz ve üyeliksiz en hızlı erişim için Yahoo üzerinden simülatör
                
                alarmlar.forEach(alarm => {
                    if(!alarm.active) return;
                    
                    let currentPrice = null;

                    // Kripto kontrolü
                    const bMatch = binanceData.find(p => p.symbol === alarm.symbol || p.symbol === (alarm.symbol + "USDT"));
                    if(bMatch) {
                        currentPrice = parseFloat(bMatch.price);
                    }

                    // Fiyat Kontrolü ve Tetikleme
                    if(currentPrice) {
                        const diff = Math.abs(currentPrice - alarm.price) / alarm.price;
                        if(diff < 0.001) { 
                            alarm.active = false;
                            triggerAlarm(alarm.symbol);
                            renderAlarms();
                        }
                    }
                });

            } catch (e) { console.log("Veri çekme hatası..."); }
        }

        function triggerAlarm(symbol) {
            speak("Dikkat! " + symbol + " hedef fiyata geldi.");
            document.getElementById('mainBody').classList.add('alarm-flash');
            setTimeout(() => { document.getElementById('mainBody').classList.remove('alarm-flash'); }, 5000);
        }

        setInterval(checkGlobalPrices, 3000);

        function changeLayout(n, btn) {
            config.layout = n;
            localStorage.setItem('ta_config', JSON.stringify(config));
            document.querySelectorAll('.active-layout').forEach(b => b.classList.remove('active-layout'));
            btn.classList.add('active-layout');
            document.getElementById('chart-grid').className = `grid-${n}`;
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`tv_${i}`);
                if (i <= n) { el.classList.remove('hidden'); initChart(`tv_${i}`, config.symbol); }
                else { el.classList.add('hidden'); el.innerHTML = ""; }
            }
        }

        function toggleSidePanel() { document.getElementById('sidePanel').classList.toggle('closed'); }

        window.onload = () => {
            changeLayout(config.layout, document.getElementById('btn-' + config.layout));
            renderAlarms();
        };
    </script>
</body>
</html>
